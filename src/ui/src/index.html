<!doctype html>
<html lang="fr">

<head>
    <link rel="icon" href="favicon.ico" />
    <meta charset="utf-8">
    <title>OpenMosfet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <!-- custom styling -->
    <style>
        .floatingNav {
        box-shadow: 0px 1px 10px #999;
        }
        #nav-menu .nav {
        display: flex;
        justify-content: center;
        }

        .card-header[data-toggle="collapse"] {
        cursor: pointer;
        }
    </style>

</head>

<body class="bg-dark text-light">
    <form id="mainForm" action="/" method="POST">
        <div class="container-fluid sticky-top bg-dark text-light" id="nav-menu">
            <div class="container text-center">
                <ul class="nav nav-pills pb-3 pt-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link text-light active" id="panel-preferences-tab" data-toggle="pill"
                            href="#panel-preferences" role="tab" aria-controls="panel-preferences"
                            aria-selected="true">Préférences</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-light" id="panel-firemodes-tab" data-toggle="pill"
                            href="#panel-firemodes" role="tab" aria-controls="panel-firemodes"
                            aria-selected="false">Modes de tir</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-light" id="panel-instructions-tab" data-toggle="pill"
                            href="#panel-instructions" role="tab" aria-controls="panel-instructions"
                            aria-selected="false">Instructions</a>
                    </li>
                </ul>
            </div>
        </div>

        <div id="mainContainer" class="container">
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="panel-preferences" role="tabpanel"
                    aria-labelledby="panel-preferences-tab">

                    <div class="row">

                        <div class="form-group col-md-6">
                            <label for="inputAppSsid">SSID Wifi</label>
                            <input type="text" class="form-control bg-dark text-light" id="inputAppSsid" name="appSsid"
                                aria-describedby="inputAppSsidHelp">
                            <small id="inputAppSsidHelp" class="form-text text-muted">Entre 8 et 32 caratères, sans
                                caractères spéciaux.</small>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inputAppPasswd">Mot de passe Wifi</label>
                            <input type="text" class="form-control bg-dark text-light" id="inputAppPasswd"
                                name="appPasswd" aria-describedby="inputAppPasswdHelp">
                            <small id="inputAppPasswdHelp" class="form-text text-muted">Entre 8 et 16 caratères, sans
                                caractères spéciaux.</small>
                        </div>

                        <div class="form-group col-md-12">
                            <!-- <label for="inputConnectToNetworkIfAvailable">Protection de la batterie</label><br> -->
                            <div class="btn-group btn-group-toggle d-flex" role="group" id="inputConnectToNetworkIfAvailable"
                                data-toggle="buttons">
                                <label class="btn btn-outline-primary active align-middle w-100"
                                    data-toggle="collapse-show" data-target="#collapseConnectToNetworkIfAvailable">
                                    <input type="radio" name="connectToNetworkIfAvailable" value="true">Utiliser un réseau connu si disponible
                                </label>
                                <label class="btn btn-outline-danger align-middle w-100" data-toggle="collapse-hide"
                                    data-target="#collapseConnectToNetworkIfAvailable">
                                    <input type="radio" name="connectToNetworkIfAvailable" value="false">Mode hotspot uniquement
                                </label>
                            </div>
                        </div>


                        <div class="col-md-12 collapse show" id="collapseConnectToNetworkIfAvailable">
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <label for="inputAvailableNetworkAppSsid">SSID Wifi externe</label>
                                    <input type="text" class="form-control bg-dark text-light" id="inputAvailableNetworkAppSsid" name="availableNetworkAppSsid"
                                        aria-describedby="inputAvailableNetworkAppSsidHelp">
                                    <small id="inputAvailableNetworkAppSsidHelp" class="form-text text-muted">Entre 8 et 32 caratères, sans
                                        caractères spéciaux.</small>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="inputAvailableNetworkAppPasswd">Mot de passe Wifi externe</label>
                                    <input type="text" class="form-control bg-dark text-light" id="inputAvailableNetworkAppPasswd"
                                        name="availableNetworkAppPasswd" aria-describedby="inputAvailableNetworkAppPasswdHelp">
                                    <small id="inputAvailableNetworkAppPasswdHelp" class="form-text text-muted">Entre 8 et 16 caratères, sans
                                        caractères spéciaux.</small>
                                </div>
                            </div>
                        </div>

                        <!-- ------------------------ WIFI SHUTDOWN AND SLEEP MODE ------------------------ -->

                        <div class="form-group col-md-6">
                            <label for="inputWifiShutdownDelayMinutes">Coupure wifi</label>

                            <div class="input-group">
                                <input type="number" min="0" step="1" id="inputWifiShutdownDelayMinutes" name="wifiShutdownDelayMinutes"
                                    class="form-control bg-dark text-light" aria-label="Recipient's username"
                                    aria-describedby="inputWifiShutdownDelayMinutesHelp">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light"
                                        id="inputWifiShutdownDelayMinutes-unit">Minutes</span>
                                </div>
                            </div>

                            <small id="inputWifiShutdownDelayMinutesHelp" class="form-text text-muted">Délais avant coupure du wifi après inutilisation de l'interface.</small>
                        </div>

                        <div class="form-group col-md-6">
                            <label for="inputDeepSleepDelayMinutes">Coupure inactivité</label>

                            <div class="input-group">
                                <input type="number" min="0" step="1" id="inputDeepSleepDelayMinutes" name="deepSleepDelayMinutes"
                                    class="form-control bg-dark text-light" aria-label="Recipient's username"
                                    aria-describedby="inputDeepSleepDelayMinutesHelp">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light"
                                        id="inputDeepSleepDelayMinutes-unit">Minutes</span>
                                </div>
                            </div>
                            
                            <small id="inputDeepSleepDelayMinutesHelp" class="form-text text-muted">Délais avant coupure du système après inactivité de la réplique.</small>
                        </div>

                        <div class="form-group col-md-12">
                            <label for="autoUpdateFromGithub">Mise à jour depuis le web</label>
                            <button id="autoUpdateFromGithub" type="submit" class="btn mt-3 btn-primary btn-block" aria-describedby="autoUpdateFromGithubHelp">
                                <span class="spinner-border spinner-border-sm" style="display: none;" role="status"></span>
                                <span class="buttonText">Mise à jour</span>
                            </button>
                        </div>

                        <div class="form-group col-md-12">
                            <!-- <label for="inputUseBatteryProtection">Protection de la batterie</label><br> -->
                            <div class="btn-group btn-group-toggle d-flex" role="group" id="inputUseBatteryProtection"
                                data-toggle="buttons">
                                <label class="btn btn-outline-primary active align-middle w-100"
                                    data-toggle="collapse-show" data-target="#collapseBatteryProtection">
                                    <input type="radio" name="useBatteryProtection" value="true">activer la Protection
                                    de la batterie
                                </label>
                                <label class="btn btn-outline-danger align-middle w-100" data-toggle="collapse-hide"
                                    data-target="#collapseBatteryProtection">
                                    <input type="radio" name="useBatteryProtection" value="false">désactiver la
                                    protection de la batterie
                                </label>
                            </div>
                        </div>


                        <div class="form-group col-md-12 collapse show" id="collapseBatteryProtection">

                            <label for="inputBatteryNominalVoltage">Voltage batterie</label>

                            <div class="input-group mb-2">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-secondary text-light">nominal</span>
                                </div>
                                <input type="text" id="inputBatteryNominalVoltage" name="batteryNominalVoltage"
                                    class="form-control bg-dark text-light" aria-label="Recipient's username"
                                    aria-describedby="inputBatteryNominalVoltage-unit">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light"
                                        id="inputBatteryNominalVoltage-unit">Volts</span>
                                </div>
                            </div>
                            <div class="input-group mb-2">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-secondary text-light">alerte</span>
                                </div>
                                <input type="text" id="inputBatteryLowVoltage" name="batteryLowVoltage"
                                    class="form-control bg-dark text-light" aria-label="Recipient's username"
                                    aria-describedby="inputBatteryLowVoltage-unit">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light"
                                        id="inputBatteryLowVoltage-unit">Volts</span>
                                </div>
                            </div>
                            
                            <div class="input-group mb-2">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-secondary text-light">coupure</span>
                                </div>
                                <input type="text" id="inputBatteryShutdownVoltage" name="batteryShutdownVoltage"
                                    class="form-control bg-dark text-light" aria-label="Recipient's username"
                                    aria-describedby="inputBatteryShutdownVoltage-unit">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-secondary text-light"
                                        id="inputBatteryShutdownVoltage-unit">Volts</span>
                                </div>
                            </div>

                        </div>

                        <div class="form-group col-md-12">
                            <!-- <label for="inputUseActiveBreaking">Active breaking</label><br> -->
                            <div class="btn-group btn-group-toggle d-flex" role="group" id="inputUseActiveBreaking"
                                data-toggle="buttons">
                                <label class="btn btn-outline-primary active align-middle w-100"
                                    data-toggle="collapse-show">
                                    <input type="radio" name="useActiveBreaking" value="true">active breaking actif
                                </label>
                                <label class="btn btn-outline-danger align-middle w-100" data-toggle="collapse-hide">
                                    <input type="radio" name="useActiveBreaking" value="false">active breaking inactif
                                </label>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="tab-pane fade" id="panel-firemodes" role="tabpanel" aria-labelledby="panel-firemodes-tab">

                </div>
                <div class="tab-pane fade" id="panel-instructions" role="tabpanel"
                    aria-labelledby="panel-instructions-tab">
                    instructions
                </div>
            </div>
        </div>
        <div id="saveContainer" class="container-fluid fixed-bottom bg-dark text-light">
            <div class="container text-center">
                <div class="row">
                    <div class="form-group col-md-12">
                        <button id="mainSubmit" type="submit" class="btn mt-3 btn-primary btn-block">
                            <span class="spinner-border spinner-border-sm" style="display: none;" role="status"></span>
                            <span class="buttonText">Enregistrer</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="js/jquery-3.5.1.min.js"></script>
        <script src="js/bootstrap.min.js"></script>

        <!-- custom script -->
        <script>
            (function ($) {
            $("[data-toggle='collapse-show']").click(function () {
                $($(this).attr("data-target")).addClass("show");
                //$($(this).attr("data-target")).collapse("show");//this don't work well because not interuptible
            })
            $("[data-toggle='collapse-hide']").click(function () {
                $($(this).attr("data-target")).removeClass("show");
                //$($(this).attr("data-target")).collapse("hide");//this don't work well because not interuptible
            })

            $(window).scroll(function () {
                if ($(window).scrollTop() > 10) {
                $('#nav-menu').addClass('floatingNav');
                } else {
                $('#nav-menu').removeClass('floatingNav');
                }
            });

            function populateWithJsonData(jsonData){
                $("input[name='appSsid']").val(jsonData["appSsid"]);
                $("input[name='appPasswd']").val(jsonData["appPasswd"]);
                $("input[name='availableNetworkAppSsid']").val(jsonData["availableNetworkAppSsid"]);
                $("input[name='availableNetworkAppPasswd']").val(jsonData["availableNetworkAppPasswd"]);
                $("input[name='wifiShutdownDelayMinutes']").val(jsonData["wifiShutdownDelayMinutes"]);
                $("input[name='deepSleepDelayMinutes']").val(jsonData["deepSleepDelayMinutes"]);
                $("input[name='batteryLowVoltage']").val(jsonData["batteryLowVoltage"]);
                $("input[name='batteryNominalVoltage']").val(jsonData["batteryNominalVoltage"]);
                $("input[name='batteryShutdownVoltage']").val(jsonData["batteryShutdownVoltage"]);

                $("input[name='connectToNetworkIfAvailable']").prop('checked', false).parent().removeClass("active");
                $("input[name='connectToNetworkIfAvailable'][value='" + jsonData["connectToNetworkIfAvailable"] + "']").prop('checked', true).parent().addClass("active").click();

                $("input[name='useBatteryProtection']").prop('checked', false).parent().removeClass("active");
                $("input[name='useBatteryProtection'][value='" + jsonData["useBatteryProtection"] + "']").prop('checked', true).parent().addClass("active").click();

                $("input[name='useActiveBreaking']").prop('checked', false).parent().removeClass("active");
                $("input[name='useActiveBreaking'][value='" + jsonData["useActiveBreaking"] + "']").prop('checked', true).parent().addClass("active").click()

                let checkedIfEqual = function(number1,number2){
                return Number(number1) == Number(number2)?"checked":""
                }
                let activeIfEqual = function(number1,number2){
                return Number(number1) == Number(number2)?"active":""
                }
                let fireModesHtml = "";
                for (fireModeKey in jsonData["fireModes"]) {
                let fireMode = jsonData["fireModes"][fireModeKey];

                fireModesHtml +=
                '<div class="card bg-dark mb-3">'+
                    '<h5 class="card-header" data-toggle="collapse" data-target="#collapseMode'+fireModeKey+'" aria-expanded="false" aria-controls="collapseMode'+fireModeKey+'">Mode '+(Number(fireModeKey)+1)+'</h5>'+
                    '<div class="card-body collapse show" id="collapseMode'+fireModeKey+'">'+
                    '<div class="row">'+

                        '<div class="col-md-12 mb-3">'+
                        '<label for="inputbBurstMode'+fireModeKey+'">Mode de rafale</label><br>'+
                        '<div class="btn-group btn-group-toggle d-flex" role="group" id="inputBurstMode'+fireModeKey+'" data-toggle="buttons">'+
                            '<label class="btn btn-outline-primary align-middle w-100 '+activeIfEqual(1,fireMode["burstMode"])+'" data-toggle="collapse-show">'+
                            '<input type="radio" name="burstMode'+fireModeKey+'" value="1" '+checkedIfEqual(1,fireMode["burstMode"])+'>interruptible'+
                        '</label>'+
                            '<label class="btn btn-outline-primary align-middle w-100 '+activeIfEqual(0,fireMode["burstMode"])+'" data-toggle="collapse-hide">'+
                            '<input type="radio" name="burstMode'+fireModeKey+'" value="0" '+checkedIfEqual(0,fireMode["burstMode"])+'>normal'+
                        '</label>'+
                            '<label class="btn btn-outline-primary align-middle w-100 '+activeIfEqual(2,fireMode["burstMode"])+'" data-toggle="collapse-hide">'+
                            '<input type="radio" name="burstMode'+fireModeKey+'" value="2" '+checkedIfEqual(2,fireMode["burstMode"])+'>extensible'+
                        '</label>'+
                        '</div>'+
                        '</div>'+
                        
                        '<div class="form-group col-md-6">'+
                        '<label for="inputBurstLength'+fireModeKey+'">Nombre de coups</label>'+
                        '<input type="number" value="'+fireMode["burstLength"]+'" name="burstLength'+fireModeKey+'" step="1" min="1" max="10" class="form-control bg-dark text-light" id="inputBurstLength'+fireModeKey+'" aria-describedby="inputBurstLengt'+fireModeKey+'hHelp">'+
                        '<small id="inputBurstLength'+fireModeKey+'Help" class="form-text text-muted">attention à ne pas mettre trop</small>'+
                        '</div>'+

                        '<div class="form-group col-md-6">'+
                        '<label for="inputTimeBetweenShots_ms'+fireModeKey+'">Délai minimum entre chaque coup</label>'+
                        '<div class="input-group">'+
                            '<input type="number" value="'+fireMode["timeBetweenShots_ms"]+'" step="1" class="form-control bg-dark text-light" name="timeBetweenShots_ms'+fireModeKey+'" id="inputTimeBetweenShots_ms'+fireModeKey+'" aria-describedby="inputTimeBetweenShots_ms'+fireModeKey+'Help">'+
                            '<div class="input-group-append">'+
                            '<span class="input-group-text" id="inputTimeBetweenShots_ms'+fireModeKey+'-unit">ms</span>'+
                            '</div>'+
                        '</div>'+
                        '<small id="inputTimeBetweenShots_ms'+fireModeKey+'Help" class="form-text text-muted">pour limiter la cadence ou pour une réplique DMR (n\'affecte pas la réactivité du tir)</small>'+
                        '</div>'+

                        '<div class="form-group col-md-6">'+
                        '<label for="inputPrecockDuration_ms'+fireModeKey+'">Durée de précocking</label>'+
                        '<div class="input-group">'+
                            '<input type="number" value="'+fireMode["precockDuration_ms"]+'" step="1" class="form-control bg-dark text-light" id="inputPrecockDuration_ms'+fireModeKey+'" name="precockDuration_ms'+fireModeKey+'" aria-describedby="inputPrecockDuration_ms'+fireModeKey+'Help">'+
                            '<div class="input-group-append">'+
                            '<span class="input-group-text" id="inputPrecockDuration_ms'+fireModeKey+'-unit">ms</span>'+
                            '</div>'+
                        '</div>'+
                        '<small id="inputPrecockDuration_ms'+fireModeKey+'Help" class="form-text text-muted">0 = pas de précocking</small>'+
                        '</div>'+

                        '<div class="form-group col-md-6">'+
                        '<label for="inputMotorPower'+fireModeKey+'">Puissance du moteur</label>'+
                        '<div class="input-group">'+
                            '<input type="number" value="'+fireMode["motorPower"]+'" step="1" class="form-control bg-dark text-light" id="inputMotorPower'+fireModeKey+'" name="motorPower'+fireModeKey+'" aria-describedby="inputMotorPower'+fireModeKey+'Help">'+
                            '<div class="input-group-append">'+
                            '<span class="input-group-text" id="inputMotorPower'+fireModeKey+'-unit">%</span>'+
                            '</div>'+
                        '</div>'+
                        '<small id="inputMotorPower'+fireModeKey+'Help" class="form-text text-muted">peut affecter la réactivité</small>'+
                        '</div>'+

                    '</div>'+
                    '</div>'+

                '</div>'
                }
                $("#panel-firemodes").html(fireModesHtml);
            }


            $("#mainForm").submit(function(event){
                event.preventDefault(); //prevent default action
                var form_data = $(this).serialize(); //Encode form elements for submission
                $("#mainSubmit .spinner-border").show();
                $("#mainSubmit .buttonText").hide();
                $.ajax({
                url : "/json",
                type: "POST",
                data : form_data
                }).done(function(response){ //
                populateWithJsonData(response);
                $("#mainSubmit .spinner-border").hide();
                $("#mainSubmit .buttonText").show();
                });
            });

            document.querySelector("#autoUpdateFromGithub").addEventListener("click" , function(event){
                event.preventDefault(); //prevent default action
                document.querySelector("#autoUpdateFromGithub .spinner-border").style.display='inline-block';
                document.querySelector("#autoUpdateFromGithub .buttonText").style.display='none';
                fetch('/api/core', { method: 'PATCH' })
                .then(response => response.json())
                .then(jsonResponse => {
                    document.querySelector("#autoUpdateFromGithub .spinner-border").style.display='none';
                    document.querySelector("#autoUpdateFromGithub .buttonText").style.display='inline-block';
                    console.log(jsonResponse)
                });
            });

            //initialize values
            jQuery.getJSON("/cfg.json", function (data) {
                populateWithJsonData(data);
            });

            //add a bottom margin so the save button doesn't hides content
            $("#mainContainer").css("margin-bottom",$("#saveContainer").height());
            $( window ).resize(function() {
                $("#mainContainer").css("margin-bottom",$("#saveContainer").height());
            });
            
            })(jQuery);
        </script>
    </form>
</body>

</html>